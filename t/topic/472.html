<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>Allow CloudFlare ip only for discourse app in docker container - 技术 - 马列毛群众</title>
<meta name="description" content="Allow CloudFlare ip only for discourse app in docker container">
<meta name="generator" content="Discourse 2.7.0.beta4 - https://github.com/discourse/discourse version 522dae22c4cea5c8c05f53771dcd6fa8085c54c2">
<link rel="icon" type="image/png" href="https://mlmmlm.icu/uploads/default/optimized/1X/a33fc15368ea2a75e178ac1d0ba6c73f0ee2998c_2_32x32.png">
<link rel="apple-touch-icon" type="image/png" href="https://mlmmlm.icu/uploads/default/optimized/1X/a33fc15368ea2a75e178ac1d0ba6c73f0ee2998c_2_180x180.png">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
<link rel="canonical" href="https://mlmmlm.icu/t/topic/472" />
<script type="application/ld+json">{"@context":"http://schema.org","@type":"WebSite","url":"https://mlmmlm.icu","potentialAction":{"@type":"SearchAction","target":"https://mlmmlm.icu/search?q={search_term_string}","query-input":"required name=search_term_string"}}</script>
<link rel="search" type="application/opensearchdescription+xml" href="https://mlmmlm.icu/opensearch.xml" title="马列毛群众 Search">
<link href="/stylesheets/desktop_91679fbb32c2a361ad6122ca6474f8ccd3e0b306.css?__ws=mlmmlm.icu" media="all" rel="stylesheet" data-target="desktop" data-theme-id="2" />
<link href="/stylesheets/desktop_theme_2_3e2557f5e9fa8e0c5cf59e3d928c10fd45659f6e.css?__ws=mlmmlm.icu" media="all" rel="stylesheet" data-target="desktop_theme" data-theme-id="2" />
<link rel="alternate" type="application/rss+xml" title=" &#39;Allow CloudFlare ip only for discourse app in docker container&#39;的RSS源" href="https://mlmmlm.icu/t/topic/472.rss" />
<meta property="og:site_name" content="马列毛群众" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="https://mlmmlm.icu/uploads/default/original/1X/a33fc15368ea2a75e178ac1d0ba6c73f0ee2998c.png" />
<meta property="og:image" content="https://mlmmlm.icu/uploads/default/original/1X/a33fc15368ea2a75e178ac1d0ba6c73f0ee2998c.png" />
<meta property="og:url" content="https://mlmmlm.icu/t/topic/472" />
<meta name="twitter:url" content="https://mlmmlm.icu/t/topic/472" />
<meta property="og:title" content="Allow CloudFlare ip only for discourse app in docker container" />
<meta name="twitter:title" content="Allow CloudFlare ip only for discourse app in docker container" />
<meta property="og:description" content="Allow CloudFlare ip only for discourse app in docker container" />
<meta name="twitter:description" content="Allow CloudFlare ip only for discourse app in docker container" />
<meta property="article:published_time" content="2021-02-25T18:31:00+00:00" />
<meta property="og:ignore_canonical" content="true" />
</head>
<body class="crawler">
<header>
<a href="/">
<img src="https://mlmmlm.icu/uploads/default/original/1X/c7a55769823a013b64a3537f903ab64eff32e4a4.png" alt="马列毛群众" id="site-logo" style="max-width: 150px;">
</a>
</header>
<div id="main-outlet" class="wrap">
<div id="topic-title">
<h1>
<a href="/t/topic/472">Allow CloudFlare ip only for discourse app in docker container</a>
</h1>
<div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
<span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
<a href="https://mlmmlm.icu/c/9-category/9" class="badge-wrapper bullet" itemprop="item">
<span class='badge-category-bg' style='background-color: #9EB83B'></span>
<span class='badge-category clear-badge'>
<span class='category-name' itemprop='name'>技术</span>
</span>
</a>
<meta itemprop="position" content="1" />
</span>
</div>
</div>
<div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
<div class='crawler-post-meta'>
<div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
<meta itemprop='name' content='马列毛群众'>
<div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop='url' content='https://mlmmlm.icu/uploads/default/original/1X/c7a55769823a013b64a3537f903ab64eff32e4a4.png'>
</div>
</div>
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href='https://mlmmlm.icu/u/mlmmlm_admin'><span itemprop='name'>mlmmlm_admin</span></a>
</span>
<link itemprop="mainEntityOfPage" href="https://mlmmlm.icu/t/topic/472">
<span class="crawler-post-infos">
<meta itemprop='datePublished' content='2021-02-25T18:31:00Z'>
<time itemprop='dateModified' datetime='2021-03-01T12:57:17Z' class='post-time'>
2021年03月1日 12:57
</time>
<span itemprop='position'>#1</span>
</span>
</div>
<div class='post' itemprop='articleBody'>
<p>Allow CloudFlare ip only for discourse app in docker container</p>
</div>
<meta itemprop='headline' content='Allow CloudFlare ip only for discourse app in docker container'>
<meta itemprop='keywords' content=''>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class='post-likes'></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
<div class='crawler-linkback-list' itemscope itemtype='http://schema.org/ItemList'>
<div itemprop='itemListElement' itemscope itemtype='http://schema.org/ListItem'>
<a href="https://mlmmlm.icu/t/topic/11/21" itemscope itemtype='http://schema.org/DiscussionForumPosting' itemprop='item'>
<meta itemprop='url' content='https://mlmmlm.icu/t/topic/11/21'>
<span itemprop='name'>公告|新用户必读</span>
</a>
<meta itemprop='position' content='1'>
</div>
</div>
</div>
<div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
<div class='crawler-post-meta'>
<div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
<meta itemprop='name' content='马列毛群众'>
<div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop='url' content='https://mlmmlm.icu/uploads/default/original/1X/c7a55769823a013b64a3537f903ab64eff32e4a4.png'>
</div>
</div>
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href='https://mlmmlm.icu/u/mlmmlm_admin'><span itemprop='name'>mlmmlm_admin</span></a>
</span>
<link itemprop="mainEntityOfPage" href="https://mlmmlm.icu/t/topic/472">
<span class="crawler-post-infos">
<time itemprop='datePublished' datetime='2021-02-25T18:32:13Z' class='post-time'>
2021年02月25日 18:32
</time>
<meta itemprop='dateModified' content='2021-02-25T18:32:13Z'>
<span itemprop='position'>#2</span>
</span>
</div>
<div class='post' itemprop='articleBody'>
<p>1.clear all rules (optional)</p>
<pre><code class="lang-auto">iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -t nat -F
iptables -t mangle -F
iptables -F
iptables -X

ip6tables -P INPUT ACCEPT
ip6tables -P FORWARD ACCEPT
ip6tables -P OUTPUT ACCEPT
ip6tables -t nat -F
ip6tables -t mangle -F
ip6tables -F
ip6tables -X
</code></pre>
</div>
<meta itemprop='headline' content='Allow CloudFlare ip only for discourse app in docker container'>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class='post-likes'></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
<div class='crawler-post-meta'>
<div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
<meta itemprop='name' content='马列毛群众'>
<div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop='url' content='https://mlmmlm.icu/uploads/default/original/1X/c7a55769823a013b64a3537f903ab64eff32e4a4.png'>
</div>
</div>
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href='https://mlmmlm.icu/u/mlmmlm_admin'><span itemprop='name'>mlmmlm_admin</span></a>
</span>
<link itemprop="mainEntityOfPage" href="https://mlmmlm.icu/t/topic/472">
<span class="crawler-post-infos">
<meta itemprop='datePublished' content='2021-02-25T18:33:59Z'>
<time itemprop='dateModified' datetime='2021-02-25T18:34:06Z' class='post-time'>
2021年02月25日 18:34
</time>
<span itemprop='position'>#3</span>
</span>
</div>
<div class='post' itemprop='articleBody'>
<p>2.restart docker (follows step one)</p>
<pre><code class="lang-auto">systemctl restart docker
</code></pre>
</div>
<meta itemprop='headline' content='Allow CloudFlare ip only for discourse app in docker container'>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class='post-likes'></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
<div class='crawler-post-meta'>
<div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
<meta itemprop='name' content='马列毛群众'>
<div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop='url' content='https://mlmmlm.icu/uploads/default/original/1X/c7a55769823a013b64a3537f903ab64eff32e4a4.png'>
</div>
</div>
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href='https://mlmmlm.icu/u/mlmmlm_admin'><span itemprop='name'>mlmmlm_admin</span></a>
</span>
<link itemprop="mainEntityOfPage" href="https://mlmmlm.icu/t/topic/472">
<span class="crawler-post-infos">
<time itemprop='datePublished' datetime='2021-02-25T18:37:42Z' class='post-time'>
2021年02月25日 18:37
</time>
<meta itemprop='dateModified' content='2021-02-25T18:37:42Z'>
<span itemprop='position'>#4</span>
</span>
</div>
<div class='post' itemprop='articleBody'>
<p>3.delete rule in DOCKER-USER below</p>
<pre><code class="lang-auto">Chain DOCKER-USER (1 references)
 pkts bytes target     prot opt in     out     source               destination
 ***  ***   RETURN     all  --  any    any     anywhere             anywhere
</code></pre>
<p>you can delete by <code>iptables -D DOCKER-USER &lt;line number of rule&gt;</code></p>
</div>
<meta itemprop='headline' content='Allow CloudFlare ip only for discourse app in docker container'>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class='post-likes'></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
<div class='crawler-post-meta'>
<div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
<meta itemprop='name' content='马列毛群众'>
<div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop='url' content='https://mlmmlm.icu/uploads/default/original/1X/c7a55769823a013b64a3537f903ab64eff32e4a4.png'>
</div>
</div>
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href='https://mlmmlm.icu/u/mlmmlm_admin'><span itemprop='name'>mlmmlm_admin</span></a>
</span>
<link itemprop="mainEntityOfPage" href="https://mlmmlm.icu/t/topic/472">
<span class="crawler-post-infos">
<meta itemprop='datePublished' content='2021-02-25T18:41:57Z'>
<time itemprop='dateModified' datetime='2021-02-26T04:32:43Z' class='post-time'>
2021年02月26日 04:32
</time>
<span itemprop='position'>#5</span>
</span>
</div>
<div class='post' itemprop='articleBody'>
<p>4.run script (adpated from <a href="https://gist.github.com/Manouchehri/cdd4e56db6596e7c3c5a" class="inline-onebox">Allow CloudFlare only · GitHub</a>)</p>
<pre><code class="lang-auto">for i in `curl https://www.cloudflare.com/ips-v4`; do iptables -I DOCKER-USER -p tcp -m multiport --dports http,https -s $i -j ACCEPT; done

iptables -A DOCKER-USER -p tcp -m multiport --dports http,https -j DROP
</code></pre>
<p>====<br>
update:<br>
after getting this done, avatars and admin dashboards are broken.</p>
<p>fix:</p>
<p>1.use <code>netstat -i</code> to check out your NICs</p>
<p>2.the scprit should be modified to</p>
<pre><code class="lang-auto">for i in `curl https://www.cloudflare.com/ips-v4`; do iptables -I DOCKER-USER -p tcp -m multiport --dports http,https -s $i -j ACCEPT; done

iptables -A DOCKER-USER -i &lt;your NIC name&gt; -p tcp -m multiport --dports http,https -j DROP
</code></pre>
</div>
<meta itemprop='headline' content='Allow CloudFlare ip only for discourse app in docker container'>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class='post-likes'></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
<div class='crawler-post-meta'>
<div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
<meta itemprop='name' content='马列毛群众'>
<div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop='url' content='https://mlmmlm.icu/uploads/default/original/1X/c7a55769823a013b64a3537f903ab64eff32e4a4.png'>
</div>
</div>
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href='https://mlmmlm.icu/u/mlmmlm_admin'><span itemprop='name'>mlmmlm_admin</span></a>
</span>
<link itemprop="mainEntityOfPage" href="https://mlmmlm.icu/t/topic/472">
<span class="crawler-post-infos">
<time itemprop='datePublished' datetime='2021-02-25T18:43:30Z' class='post-time'>
2021年02月25日 18:43
</time>
<meta itemprop='dateModified' content='2021-02-25T18:43:30Z'>
<span itemprop='position'>#6</span>
</span>
</div>
<div class='post' itemprop='articleBody'>
<p>5.<code>dpkg-reconfigure iptables-persistent</code></p>
</div>
<meta itemprop='headline' content='Allow CloudFlare ip only for discourse app in docker container'>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class='post-likes'></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
<div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
<div class='crawler-post-meta'>
<div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
<meta itemprop='name' content='马列毛群众'>
<div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
<meta itemprop='url' content='https://mlmmlm.icu/uploads/default/original/1X/c7a55769823a013b64a3537f903ab64eff32e4a4.png'>
</div>
</div>
<span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a itemprop="url" href='https://mlmmlm.icu/u/mlmmlm_admin'><span itemprop='name'>mlmmlm_admin</span></a>
</span>
<link itemprop="mainEntityOfPage" href="https://mlmmlm.icu/t/topic/472">
<span class="crawler-post-infos">
<time itemprop='datePublished' datetime='2021-02-25T18:50:14Z' class='post-time'>
2021年02月25日 18:50
</time>
<meta itemprop='dateModified' content='2021-02-25T18:50:14Z'>
<span itemprop='position'>#7</span>
</span>
</div>
<div class='post' itemprop='articleBody'>
<p>finally, the port scanning result shoud be like this:</p>
<div class="md-table">
<table>
<thead>
<tr>
<th>Port Number</th>
<th>State</th>
<th>Service Name</th>
<th>Service Product</th>
<th>Service Version</th>
<th>Service Extra Info</th>
</tr>
</thead>
<tbody>
<tr>
<td>22</td>
<td>open</td>
<td>ssh</td>
<td>OpenSSH</td>
<td>********</td>
<td>*******</td>
</tr>
<tr>
<td>79</td>
<td>filtered</td>
<td>finger</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>80</td>
<td>filtered</td>
<td>http</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>443</td>
<td>filtered</td>
<td>https</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>5051</td>
<td>filtered</td>
<td>ida-agent</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div>
</div>
<meta itemprop='headline' content='Allow CloudFlare ip only for discourse app in docker container'>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/LikeAction" />
<meta itemprop="userInteractionCount" content="0" />
<span class='post-likes'></span>
</div>
<div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
<meta itemprop="interactionType" content="http://schema.org/CommentAction" />
<meta itemprop="userInteractionCount" content="0" />
</div>
</div>
</div>
<footer class="container wrap">
<nav class='crawler-nav'>
<ul>
<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
<span itemprop='name'>
<a href='/' itemprop="url">首页 </a>
</span>
</li>
<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
<span itemprop='name'>
<a href='/categories' itemprop="url">分类 </a>
</span>
</li>
<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
<span itemprop='name'>
<a href='/guidelines' itemprop="url">FAQ/指引 </a>
</span>
</li>
<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
<span itemprop='name'>
<a href='/tos' itemprop="url">服务条款 </a>
</span>
</li>
<li itemscope itemtype='http://schema.org/SiteNavigationElement'>
<span itemprop='name'>
<a href='/privacy' itemprop="url">隐私政策 </a>
</span>
</li>
</ul>
</nav>
<p class='powered-by-link'>由 <a href="https://www.discourse.org">Discourse</a>提供支持，启用 JavaScript 以获得最佳体验</p>
</footer>
</body>
</html>
